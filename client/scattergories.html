<!DOCTYPE html>
<html>
  
  <script src="/socket.io/socket.io.js"></script>
<script>
  const socket=io.connect("http://localhost:8080")
    var list=new Array();
    list=JSON.parse(sessionStorage.getItem("list"));
    var id=JSON.parse(sessionStorage.getItem("id"));
    var name=JSON.parse(sessionStorage.getItem("name"));
    var Pstatus={};
    var type;
    if(list!=null)
    {
      socket.emit("createRoom",{
        input:id,
        categories:list,
        name:name
      })
    }
    else{
      socket.emit("joinRoom",{
        input:id,
        name:name
      });
  }
    var stop=0;
    var score;
    function wait(num){
      var score=document.getElementById('score');
      score.innerHTML="waiting for host to start game";
      document.getElementById('players').innerHTML=name+":0";
      if(num==0){//creating start game button only for host
        var bdy=document.getElementById('bdy');
        var button=document.createElement("button");
        button.setAttribute('type','button');
        button.setAttribute('onclick','begin()');
        button.innerHTML="start game";
        button.setAttribute('id','startGame');
        bdy.appendChild(button);
      }
    }
    function begin(){
      socket.emit("begin",{
        room:id,
        num:1
      });
      type=0;
      start_game(type);
    }
    function start_game(num){ 
      var bdy=document.getElementById('bdy');
      
      if(num==0){//creating roll button only for host
        bdy.removeChild(document.getElementById('startGame'));
        var roll=document.createElement("input");
        roll.setAttribute('type','button');
        roll.setAttribute('value','roll');
        roll.setAttribute('onclick','roll(0)');
        roll.setAttribute('id','sbut');
        roll.setAttribute('style','margin-bottom:20px;')
        document.getElementById("rollButton").appendChild(roll);
      }
      var time=document.getElementById('time')
      time.innerHTML="120";
      score=0;
      var form = document.getElementsByTagName('form')[0];
        document.getElementById("score").innerHTML="score:"+score;
        if(list!=null){
          tableCreate(list);
          var sub=document.createElement("input");
          sub.setAttribute('type','button');
          sub.setAttribute('value','submit');
          sub.setAttribute('onclick','return check_input()');
          sub.setAttribute('id','submitBut');
          sub.setAttribute('style','margin-top:20px;');
          form.appendChild(sub);
        }
    }
    function tableCreate(x) {
      var form = document.getElementsByTagName('form')[0];
      var tbl = document.createElement('table');
      tbl.style.width = '100%';
      tbl.setAttribute('border', '1');
      var tbdy = document.createElement('tbody');
      for (var i = 0; i < 2; i++) {
        var tr = document.createElement('tr');
        for (var j = 0; j < x.length; j++) {
          if (i == 2 && j == 1) {
            break;
          } else {
            var td = document.createElement('td');
            i==0 ? td.appendChild(document.createTextNode(x[j])) : null;
            i == 1 && j == 1 ? td.setAttribute('rowSpan', '2') : null;
            i==1? td.appendChild(create_input(list,j)) : null;
            tr.appendChild(td);
        }
    }
    tbdy.appendChild(tr);
  }
  tbl.appendChild(tbdy);
  form.appendChild(tbl);
}
function create_input(list,num){
  var x=document.createElement('input')
  x.setAttribute('name',list[num]);
  x.setAttribute('id',list[num]);
  return x;

}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
async function roll(x,letter){
  stop=0;
  var time=document.getElementById('time');
  var div=document.getElementById('letter');
  if(x==0){
    for(var key in Pstatus)
    {
      if(Pstatus[key]==0){
        alert("pls wait for everyone to finish submiting");
        return;
      }
    }
    for(var key in Pstatus)
    {
      Pstatus[key]=0;
    }
    var num=Math.round((Math.random()*25)+65);
    num=String.fromCharCode(num);
    div.innerHTML=num;
    socket.emit("roll",{
      room:id,
      num:1,
      letter:num,
      status:Pstatus
    });
    document.getElementById('sbut').setAttribute('onclick','');
  }
  else
  {
    div.innerHTML=letter
  }
  document.getElementById('submitBut').setAttribute('onclick','return check_input()');
  var i=120;
  while(i>0){
    socket.on("countDown",async function(data){
      document.getElementById("report").innerHTML=data;
      i=10;
    });
    i--;
    await sleep(1000);
    time.innerHTML=i;
    if(stop==-1){
      time.innerHTML=120;
      return;
    }
  }
  document.getElementById("report").innerHTML="";
    check_input();
}

function check_input(){
  var v=new Array();
  var input=new Array();
  var letter=document.getElementById('letter').innerHTML.toLowerCase();
  for(var i=0;i<list.length;i++)
  {
    v.push(document.getElementById(list[i]));
    if(v.length>0&&v[i].value.length>0){
      if(v[i].value.charAt(0)!=letter&&v[i].value.charAt(0)!=letter.toUpperCase()){//if input doesnt start with the right letter
        //delete the value so player wont recieve points
        v[i].style.borderColor="red";
        v[i].value="";
        document.getElementById("report").innerHTML="input doesnt match letter";
      }
    }
    input.push(v[i].value);
    v[i].value="";
  }
  socket.emit('input',{
    categories:list,
    input:input,
    id:id
  });
  document.getElementById('submitBut').setAttribute('onclick','alert("pls wait for host to roll again");')
  reset_game(v);
  return true;
}
async function reset_game(v){
  stop=-1;
  if(type==0)
    document.getElementById('sbut').setAttribute('onclick','roll(0)');
  document.getElementById('letter').innerHTML="A";
  document.getElementById('time').innerHTML=120;
  await sleep(2000);
  document.getElementById('report').innerHTML="";
  for(var i=0;i<v.length;i++)
  {
    v[i].style.removeProperty('border');
  }
}
function update_score(){
  document.getElementById("score").innerHTML="score:"+score;
}
socket.on("roomExists",function(data){
  sessionStorage.setItem("roomExists","room exists")
  window.location.pathname ='/';
});
socket.on("created",function(data){
  Pstatus=data.status;//dictionary of player status(to check if the host can roll again)
  wait(data.num);
});
socket.on("exists",function(data){
  sessionStorage.setItem("exists","name exists");
  window.location.pathname ='/';
});
socket.on("notFound",function(data){
  sessionStorage.setItem("notFound","room not found");
  window.location.pathname ='/';
});
socket.on("playerJoined",async function(data){
  Pstatus=data.status;
  var names=JSON.stringify(data.players);
  names=names.replace('{','');
  names=names.replace('}','');
  while(names.indexOf('"')!=-1)
  {
    names=names.replace('"','');
  }
  while(names.indexOf(',')!=-1)
  {
    names=names.replace(',','<br />');
  }
  document.getElementById('players').innerHTML=names
  document.getElementById('report').style.color="green";
  document.getElementById('report').innerHTML="player "+data.name+" joined";
  await sleep(3000);
  document.getElementById('report').innerHTML="";
  document.getElementById('report').style.color="red";
});
socket.on("success",(data)=>{
  type=data.num;
  wait(type);
  list=data.categories;
  var names=JSON.stringify(data.players);
  names=names.replace('{','');
  names=names.replace('}','');
  while(names.indexOf('"')!=-1)
  {
    names=names.replace('"','');
  }
  while(names.indexOf(',')!=-1)
  {
    names=names.replace(',','<br />');
  }
  document.getElementById('players').innerHTML=names

});
socket.on("playerLeft",async function(data){
  Pstatus=data.status;
  var names=JSON.stringify(data.players);
  names=names.replace('{','');
  names=names.replace('}','');
  while(names.indexOf('"')!=-1)
  {
    names=names.replace('"','');
  }
  while(names.indexOf(',')!=-1)
  {
    names=names.replace(',','<br />');
  }
  document.getElementById('players').innerHTML=names;
  document.getElementById('report').innerHTML="player "+data.name+" left";
  await sleep(3000);
  document.getElementById('report').innerHTML="";
});
socket.on("begin",function(data){
  start_game(data.num);
});
socket.on("roll",function(data){
  roll(data.num,data.letter);
});

socket.on("scoreboard",function(data){
  Pstatus=data.status;
  score=data.players[name];
  update_score();
  var names=JSON.stringify(data.players);
  names=names.replace('{','');
  names=names.replace('}','');
  while(names.indexOf('"')!=-1)
  {
    names=names.replace('"','');
  }
  while(names.indexOf(',')!=-1)
  {
    names=names.replace(',','<br />');
  }
  document.getElementById('players').innerHTML=names;
});
</script>
<title >Scattergories</title>
<body id="bdy" style="text-align: center;">
<h1 id="score" style="font-size:300%;" ></h1>
<br>
<div style="position: absolute;"></div>
<div id="players" style="font-size: 150%; text-align: left;"></div>
<div id="time" style="font-size: 250%; text-align: left;"></div>
<div id='letter' style="font-size:250%;">A</div>
<br>
<div id="rollButton"></div>
<form id="myform" action="/client/scattergories.html" method="GET">
</form>
<div id="report" style="color: red;"></div>
<br>
</body>
</html>